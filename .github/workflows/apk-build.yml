name: APK Build & Release

on:
  workflow_run:
    workflows:
      - Version Management
    types:
      - completed

  workflow_dispatch:
    inputs:
      tag:
        description: 'ë¹Œë“œí•  íƒœê·¸ (ì˜ˆ: v1.0.0)'
        required: true
        type: string

env:
  NODE_VERSION: '20'
  JAVA_VERSION: '17'
  ANDROID_API_LEVEL: '34'
  ANDROID_BUILD_TOOLS: '34.0.0'
  APP_NAME: 'MeetTime'
  WEBSITE_URL: 'https://meet.chuseok22.com'
  PACKAGE_ID: 'com.meettime.app'

permissions:
  contents: write
  actions: read

jobs:
  # 1) ì–´ë–¤ íƒœê·¸ë¥¼ ë¹Œë“œí• ì§€ ê²°ì •
  resolve-tag:
    name: ğŸ” Resolve Tag
    runs-on: ubuntu-latest
    # Version Management ì„±ê³µ(run) ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰(dispatch)ë§Œ í—ˆìš©
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    outputs:
      tag: ${{ steps.get-tag.outputs.tag }}
      version: ${{ steps.get-tag.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve tag from event
        id: get-tag
        run: |
          set -euo pipefail

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            # Version Managementê°€ ë§Œë“  ë¦´ë¦¬ìŠ¤ ì»¤ë°‹ì˜ SHA
            SHA="${{ github.event.workflow_run.head_sha }}"
            git fetch --tags --force

            # í•´ë‹¹ SHAë¥¼ ê°€ë¦¬í‚¤ëŠ” vX.Y.Z íƒœê·¸ ì¶”ì¶œ(ì—¬ëŸ¬ ê°œë©´ ê°€ì¥ í° ë²„ì „ ì„ íƒ)
            TAG="$(git tag --points-at "$SHA" | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n1 || true)"
            if [ -z "$TAG" ]; then
              echo "âŒ íƒœê·¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. SHA=$SHA ì— vX.Y.Z íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤."
              exit 1
            fi
          fi

          if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ ì˜ëª»ëœ íƒœê·¸ í˜•ì‹: $TAG (v1.2.3 í˜•ì‹ì´ì–´ì•¼ í•¨)"
            exit 1
          fi

          VERSION="${TAG#v}"

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "âœ… Resolved: TAG=$TAG, VERSION=$VERSION"

  # 2) ì‹¤ì œ apk ë¹Œë“œ & ë¦´ë¦¬ìŠ¤
  build-apk:
    name: ğŸ¤– Build MeetTime Android APK
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ·ï¸ í˜„ì¬ ë²„ì „ í™•ì¸
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="${GITHUB_REF#refs/tags/}"
          fi
          
          # íƒœê·¸ í˜•ì‹ ê²€ì¦ (v1.2.3)
          if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ ì˜ëª»ëœ íƒœê·¸ í˜•ì‹: $TAG (v1.2.3 í˜•ì‹ì´ì–´ì•¼ í•¨)"
            exit 1
          fi
          
          VERSION="${TAG#v}"  # v1.2.3 â†’ 1.2.3
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ·ï¸ MeetTime ë¹Œë“œ ë²„ì „: $TAG ($VERSION)"

      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.version.outputs.tag }}
          fetch-depth: 0

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: â˜• Setup Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: ğŸ¤– Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: ${{ env.ANDROID_API_LEVEL }}
          build-tools: ${{ env.ANDROID_BUILD_TOOLS }}

      - name: ğŸ“¥ Node.js ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          echo "ğŸ“¥ Node.js ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
          npm ci
          echo "âœ… Node.js ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"

      - name: ğŸ—ï¸ Build Next.js Application
        run: |
          echo "ğŸ—ï¸ MeetTime ì›¹ì•± ë¹Œë“œ ì‹œì‘..."
          npm run build
          
          # ë¹Œë“œ ê²°ê³¼ í™•ì¸
          if [ ! -d "out" ] && [ ! -d ".next" ]; then
            echo "âŒ Next.js ë¹Œë“œ ì‹¤íŒ¨: out ë˜ëŠ” .next ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤"
            exit 1
          fi
          
          echo "âœ… MeetTime ì›¹ì•± ë¹Œë“œ ì™„ë£Œ"
          
      - name: ğŸ“± Install Bubblewrap CLI
        run: |
          echo "ğŸ“± Bubblewrap CLI ì„¤ì¹˜ ì¤‘..."
          npm install -g @bubblewrap/cli
          bubblewrap --version
          echo "âœ… Bubblewrap CLI ì„¤ì¹˜ ì™„ë£Œ"

      - name: ğŸ”§ Create Android Build Directory
        run: |
          # GitHub Actions ê°€ìƒë¨¸ì‹  ë‚´ë¶€ì— ì„ì‹œ ë¹Œë“œ í´ë” ìƒì„±
          echo "ğŸ“ Android ë¹Œë“œ ë””ë ‰í† ë¦¬ ìƒì„± ì¤‘..."
          mkdir -p android-build
          cd android-build
          pwd
          echo "âœ… ë¹Œë“œ ë””ë ‰í† ë¦¬ ìƒì„± ì™„ë£Œ: $(pwd)"

      - name: ğŸ” Keystore base64 ë””ì½”ë”©
        run: |
          cd android-build
          
          # ğŸ”‘ GitHub Secretsì—ì„œ í‚¤ìŠ¤í† ì–´ ë³µì›
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android.keystore
          
          # í‚¤ìŠ¤í† ì–´ íŒŒì¼ í™•ì¸
          if [ ! -f "android.keystore" ]; then
            echo "âŒ í‚¤ìŠ¤í† ì–´ íŒŒì¼ ë³µì› ì‹¤íŒ¨"
            exit 1
          fi
          
          # í‚¤ìŠ¤í† ì–´ ì •ë³´ ê²€ì¦ (alias í™•ì¸)
          echo "ğŸ” í‚¤ìŠ¤í† ì–´ ì •ë³´ í™•ì¸:"
          keytool -list -keystore android.keystore -storepass "${{ secrets.KEYSTORE_PASSWORD }}" | grep "android"
          
          echo "âœ… í”„ë¡œë•ì…˜ í‚¤ìŠ¤í† ì–´ ë³µì› ì™„ë£Œ (alias: android)"

      - name: ğŸŒ Initialize TWA Project
        run: |
          cd android-build
          VERSION="${{ steps.version.outputs.version }}"
          
          bubblewrap init \
            --manifest ${{ env.WEBSITE_URL }}/manifest.webmanifest \
            --directory . \
            --packageId ${{ env.PACKAGE_ID }} \
            --name "${{ env.APP_NAME }}" \
            --launcherName "${{ env.APP_NAME }}" \
            --display standalone \
            --orientation portrait \
            --themeColor "#3b82f6" \
            --backgroundColor "#ffffff" \
            --startUrl "/" \
            --iconUrl ${{ env.WEBSITE_URL }}/icons/icon-512x512.png \
            --maskableIconUrl ${{ env.WEBSITE_URL }}/icons/icon-512x512.png \
            --splashScreenFadeOutDuration 300 \
            --enableNotifications true \
            --minSdkVersion 21 \
            --targetSdkVersion ${{ env.ANDROID_API_LEVEL }} \
            --versionCode $(echo "$VERSION" | sed 's/\.//g')$(date +%m%d) \
            --versionName "$VERSION"
          
          echo "âœ… TWA í”„ë¡œì íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ"

      - name: ğŸ—ï¸ Build Signed APK
        run: |
          cd android-build
          
          # Gradle wrapper ê¶Œí•œ ì„¤ì •
          if [ -f "gradlew" ]; then
            chmod +x gradlew
          fi
          
          # ğŸ” ê¸°ì¡´ í‚¤ìŠ¤í† ì–´ë¡œ ì„œëª…ëœ APK ë¹Œë“œ
          bubblewrap build \
            --skipPwaValidation \
            --keystore android.keystore \
            --keystorePassword "${{ secrets.KEYSTORE_PASSWORD }}" \
            --keyPassword "${{ secrets.KEY_PASSWORD }}" \
            --alias android
          
          echo "âœ… ì„œëª…ëœ APK ë¹Œë“œ ì™„ë£Œ (alias: android)"

      - name: ğŸ“ Prepare APK File
        id: apk-info
        run: |
          cd android-build
          VERSION="${{ steps.version.outputs.version }}"
          
          # APK íŒŒì¼ ì°¾ê¸°
          APK_PATHS=(
            "app-release.apk"
            "app/build/outputs/apk/release/app-release.apk"
            "app/build/outputs/apk/release/app-release-unsigned.apk"
            "build/outputs/apk/release/app-release.apk"
          )
          
          APK_FILE=""
          for path in "${APK_PATHS[@]}"; do
            if [ -f "$path" ]; then
              APK_FILE="$path"
              break
            fi
          done
          
          if [ -z "$APK_FILE" ]; then
            echo "âŒ APK íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            find . -name "*.apk" -type f
            exit 1
          fi
          
          # APK íŒŒì¼ëª… ë³€ê²½
          NEW_APK_NAME="meettime-v${VERSION}.apk"
          cp "$APK_FILE" "../$NEW_APK_NAME"
          
          APK_SIZE=$(du -h "../$NEW_APK_NAME" | cut -f1)
          APK_PATH="../$NEW_APK_NAME"
          
          echo "apk-name=$NEW_APK_NAME" >> $GITHUB_OUTPUT
          echo "apk-path=$APK_PATH" >> $GITHUB_OUTPUT
          echo "apk-size=$APK_SIZE" >> $GITHUB_OUTPUT
          
          echo "ğŸ“± APK ì¤€ë¹„ ì™„ë£Œ: $NEW_APK_NAME ($APK_SIZE)"

      - name: ğŸ” APK Verification
        run: |
          APK_PATH="${{ steps.apk-info.outputs.apk-path }}"
          
          echo "ğŸ” APK ì„œëª… ê²€ì¦:"
          
          # APK ì„œëª… ì •ë³´ í™•ì¸
          if command -v jarsigner >/dev/null 2>&1; then
            jarsigner -verify -verbose -certs "$APK_PATH" | head -20
          fi
          
          # ê¸°ë³¸ íŒŒì¼ ì •ë³´
          ls -la "$APK_PATH"
          echo "âœ… APK ê²€ì¦ ì™„ë£Œ"

      - name: ğŸ“¤ Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: meettime-apk-${{ steps.version.outputs.version }}
          path: ${{ steps.apk-info.outputs.apk-path }}
          retention-days: 90

      - name: ğŸ‰ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "ğŸš€ MeetTime ${{ steps.version.outputs.tag }}"
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            ${{ steps.apk-info.outputs.apk-path }}
          body: |
            ## ğŸš€ MeetTime ${{ steps.version.outputs.tag }}
            
            **í”„ë¡œë•ì…˜ í‚¤ìŠ¤í† ì–´ë¡œ ì„œëª…ëœ ì•ˆì •ì ì¸ ë²„ì „ì…ë‹ˆë‹¤!** ğŸ”
            
            ### ğŸ“± Android APK
            - **íŒŒì¼ëª…**: `${{ steps.apk-info.outputs.apk-name }}`
            - **í¬ê¸°**: ${{ steps.apk-info.outputs.apk-size }}
            - **ì„œëª…**: âœ… í”„ë¡œë•ì…˜ í‚¤ìŠ¤í† ì–´ë¡œ ì„œëª…ë¨
            - **ì—…ë°ì´íŠ¸ í˜¸í™˜**: âœ… ê¸°ì¡´ ì„¤ì¹˜ëœ ì•± ì—…ë°ì´íŠ¸ ê°€ëŠ¥
            
            ### ğŸ“¥ ì„¤ì¹˜ ë°©ë²•
            1. ğŸ“² `${{ steps.apk-info.outputs.apk-name }}` ë‹¤ìš´ë¡œë“œ
            2. âš™ï¸ Android ì„¤ì • > ë³´ì•ˆ > "ì•Œ ìˆ˜ ì—†ëŠ” ì†ŒìŠ¤" í—ˆìš©
            3. ğŸ“± APK íŒŒì¼ ì‹¤í–‰í•˜ì—¬ ì„¤ì¹˜/ì—…ë°ì´íŠ¸
            
            ### ğŸŒ ì›¹ ë²„ì „
            [${{ env.WEBSITE_URL }}](${{ env.WEBSITE_URL }})
            
            ### ğŸ” ë³´ì•ˆ ì •ë³´
            - **í‚¤ìŠ¤í† ì–´**: í”„ë¡œë•ì…˜ìš© ì•ˆì „í•œ í‚¤ìŠ¤í† ì–´ ì‚¬ìš©
            - **ì„œëª… ê²€ì¦**: GitHub Actionsì—ì„œ ìë™ ê²€ì¦
            - **íŒ¨í‚¤ì§€ ID**: `${{ env.PACKAGE_ID }}`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“Š Build Summary
        run: |
          echo "ğŸ‰ MeetTime APK ë¹Œë“œ ì„±ê³µ!"
          echo "ğŸ“¦ ë²„ì „: ${{ steps.version.outputs.tag }}"
          echo "ğŸ“± APK: ${{ steps.apk-info.outputs.apk-name }}"
          echo "ğŸ” í‚¤ìŠ¤í† ì–´: í”„ë¡œë•ì…˜ìš© (ê¸°ì¡´ í‚¤ìŠ¤í† ì–´ ì‚¬ìš©)"
          echo "ğŸ”— ë¦´ë¦¬ì¦ˆ: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}"