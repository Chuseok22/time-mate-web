name: APK Build & Release

on:
  push:
    tags:
      - 'v*'   # âœ… v* íƒœê·¸ í‘¸ì‹œ ì‹œì—ë§Œ ì‹¤í–‰

  workflow_dispatch:
    inputs:
      tag:
        description: 'ë¹Œë“œí•  íƒœê·¸ (ì˜ˆ: v1.0.0)'
        required: true
        type: string

env:
  NODE_VERSION: '20'
  JAVA_VERSION: '17'
  ANDROID_API_LEVEL: '34'
  ANDROID_BUILD_TOOLS: '34.0.0'
  APP_NAME: 'MeetTime'
  WEBSITE_URL: 'https://meet.chuseok22.com'
  PACKAGE_ID: 'com.meettime.app'

permissions:
  contents: write
  actions: read

jobs:
  # 1) ì–´ë–¤ íƒœê·¸ë¥¼ ë¹Œë“œí• ì§€ ê²°ì •
  # ğŸ¯ í•µì‹¬: ë²„ì „ì´ ì‹¤ì œë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆëŠ”ì§€ í™•ì¸
  check-version-update:
    name: ğŸ” Check Version Update
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    outputs:
      should-build: ${{ steps.check-update.outputs.should-build }}
      tag: ${{ steps.check-update.outputs.tag }}
      version: ${{ steps.check-update.outputs.version }}

    steps:
      - name: ğŸ›ï¸ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0


      - name: ğŸ” Check if version was actually updated
        id: check-update
        run: |
          set -Eeuo pipefail

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # ìˆ˜ë™ ì‹¤í–‰ì¸ ê²½ìš°
            TAG="${{ github.event.inputs.tag }}"
            # FIX: íƒœê·¸ í˜•ì‹ ê²€ì¦
            if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "âŒ ì˜ëª»ëœ íƒœê·¸ í˜•ì‹: $TAG (v1.2.3 í˜•ì‹ì´ì–´ì•¼ í•¨)"
              exit 1
            fi
            VERSION="${TAG#v}"
            echo "should-build=true" >> $GITHUB_OUTPUT
            echo "tag=$TAG" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "âœ… ìˆ˜ë™ ì‹¤í–‰: $TAG"
          else
            # Version Management ì›Œí¬í”Œë¡œ ì™„ë£Œ í›„
            BRANCH="${{ github.event.workflow_run.head_branch }}"
            git fetch --tags --force

            if [ -n "$BRANCH" ]; then
              git fetch origin "$BRANCH":"refs/remotes/origin/$BRANCH"
              git checkout -qf "origin/$BRANCH"
            fi

            # FIX: ë¦´ë¦¬ìŠ¤ ì»¤ë°‹ ë©”ì‹œì§€ì—ì„œ vX.Y.Z íŒŒì‹± (ê°€ì¥ ìµœê·¼ 50ê°œ ì¤‘ ì²« ë§¤ì¹­)
            REL_TAG="$(git log -n 50 --pretty=format:%s | grep -Eo '^chore\(release\): v[0-9]+\.[0-9]+\.[0-9]+' | head -n1 | sed -E 's/^chore\(release\): (v[0-9]+\.[0-9]+\.[0-9]+).*/\1/')"

            # ë³´ì™„: HEADë¥¼ ê°€ë¦¬í‚¤ëŠ” vX.Y.Z íƒœê·¸ê°€ ìˆìœ¼ë©´ ì‚¬ìš©
            if [ -z "$REL_TAG" ]; then
              REL_TAG="$(git tag --points-at HEAD | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n1 || true)"
            fi

            if [ -n "$REL_TAG" ]; then
              VERSION="${REL_TAG#v}"
              echo "should-build=true" >> $GITHUB_OUTPUT
              echo "tag=$REL_TAG" >> $GITHUB_OUTPUT
              echo "version=$VERSION" >> $GITHUB_OUTPUT
              echo "âœ… ìƒˆ ë²„ì „ íƒœê·¸ ê°ì§€: $REL_TAG"
            else
              echo "should-build=false" >> $GITHUB_OUTPUT
              echo "ğŸ“ ìƒˆ ë²„ì „ íƒœê·¸ê°€ ì—†ìŒ - APK ë¹Œë“œ ê±´ë„ˆëœ€"
            fi
          fi

  # ğŸš€ ì‹¤ì œ APK ë¹Œë“œ (ìƒˆ ë²„ì „ì´ ìˆì„ ë•Œë§Œ)
  build-apk:
    name: ğŸ¤– Build MeetTime Android APK
    runs-on: ubuntu-latest
    needs: check-version-update
    if: needs.check-version-update.outputs.should-build == 'true'

    steps:
      - name: ğŸ·ï¸ ë²„ì „ ì •ë³´
        run: |
          echo "ğŸ·ï¸ ë¹Œë“œí•  ë²„ì „: ${{ needs.check-version-update.outputs.tag }}"
          echo "ğŸ“¦ ë²„ì „ ë²ˆí˜¸: ${{ needs.check-version-update.outputs.version }}"

      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.check-version-update.outputs.tag }}
          fetch-depth: 0

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: â˜• Setup Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: ğŸ¤– Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: ${{ env.ANDROID_API_LEVEL }}
          build-tools: ${{ env.ANDROID_BUILD_TOOLS }}

      - name: ğŸ“¥ Node.js ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          echo "ğŸ“¥ Node.js ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
          npm ci
          echo "âœ… Node.js ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"

      - name: ğŸ—ï¸ Build Next.js Application
        run: |
          echo "ğŸ—ï¸ MeetTime ì›¹ì•± ë¹Œë“œ ì‹œì‘..."
          npm run build
          
          echo "âœ… MeetTime ì›¹ì•± ë¹Œë“œ ì™„ë£Œ"
          
      - name: ğŸ“± Install Bubblewrap CLI
        run: |
          echo "ğŸ“± Bubblewrap CLI ì„¤ì¹˜ ì¤‘..."
          npm install -g @bubblewrap/cli
          bubblewrap --version
          echo "âœ… Bubblewrap CLI ì„¤ì¹˜ ì™„ë£Œ"

      - name: ğŸ”§ Create Android Build Directory
        run: |
          # GitHub Actions ê°€ìƒë¨¸ì‹  ë‚´ë¶€ì— ì„ì‹œ ë¹Œë“œ í´ë” ìƒì„±
          echo "ğŸ“ Android ë¹Œë“œ ë””ë ‰í† ë¦¬ ìƒì„± ì¤‘..."
          mkdir -p android-build
          cd android-build
          pwd
          echo "âœ… ë¹Œë“œ ë””ë ‰í† ë¦¬ ìƒì„± ì™„ë£Œ: $(pwd)"

      - name: ğŸ” Keystore base64 ë””ì½”ë”©
        run: |
          cd android-build
          
          # ğŸ”‘ GitHub Secretsì—ì„œ í‚¤ìŠ¤í† ì–´ ë³µì›
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android.keystore
          
          # í‚¤ìŠ¤í† ì–´ íŒŒì¼ í™•ì¸
          if [ ! -f "android.keystore" ]; then
            echo "âŒ í‚¤ìŠ¤í† ì–´ íŒŒì¼ ë³µì› ì‹¤íŒ¨"
            exit 1
          fi
          
          # í‚¤ìŠ¤í† ì–´ ì •ë³´ ê²€ì¦ (alias í™•ì¸)
          echo "ğŸ” í‚¤ìŠ¤í† ì–´ ì •ë³´ í™•ì¸:"
          keytool -list -keystore android.keystore -storepass "${{ secrets.KEYSTORE_PASSWORD }}" | grep "android"
          
          echo "âœ… í”„ë¡œë•ì…˜ í‚¤ìŠ¤í† ì–´ ë³µì› ì™„ë£Œ (alias: android)"

      - name: ğŸŒ Initialize TWA Project
        run: |
          cd android-build
          VERSION="${{ steps.version.outputs.version }}"
          
          bubblewrap init \
            --manifest ${{ env.WEBSITE_URL }}/manifest.webmanifest \
            --directory . \
            --packageId ${{ env.PACKAGE_ID }} \
            --name "${{ env.APP_NAME }}" \
            --launcherName "${{ env.APP_NAME }}" \
            --display standalone \
            --orientation portrait \
            --themeColor "#3b82f6" \
            --backgroundColor "#ffffff" \
            --startUrl "/" \
            --iconUrl ${{ env.WEBSITE_URL }}/icons/icon-512x512.png \
            --maskableIconUrl ${{ env.WEBSITE_URL }}/icons/icon-512x512.png \
            --splashScreenFadeOutDuration 300 \
            --enableNotifications true \
            --minSdkVersion 21 \
            --targetSdkVersion ${{ env.ANDROID_API_LEVEL }} \
            --versionCode $(echo "$VERSION" | sed 's/\.//g')$(date +%m%d) \
            --versionName "$VERSION"
          
          echo "âœ… TWA í”„ë¡œì íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ"

      - name: ğŸ—ï¸ Build Signed APK
        run: |
          cd android-build
          
          # Gradle wrapper ê¶Œí•œ ì„¤ì •
          if [ -f "gradlew" ]; then
            chmod +x gradlew
          fi
          
          # ğŸ” ê¸°ì¡´ í‚¤ìŠ¤í† ì–´ë¡œ ì„œëª…ëœ APK ë¹Œë“œ
          bubblewrap build \
            --skipPwaValidation \
            --keystore android.keystore \
            --keystorePassword "${{ secrets.KEYSTORE_PASSWORD }}" \
            --keyPassword "${{ secrets.KEY_PASSWORD }}" \
            --alias android
          
          echo "âœ… ì„œëª…ëœ APK ë¹Œë“œ ì™„ë£Œ (alias: android)"

      - name: ğŸ“ Prepare APK File
        id: apk-info
        run: |
          cd android-build
          VERSION="${{ steps.version.outputs.version }}"
          
          # APK íŒŒì¼ ì°¾ê¸°
          APK_PATHS=(
            "app-release.apk"
            "app/build/outputs/apk/release/app-release.apk"
            "app/build/outputs/apk/release/app-release-unsigned.apk"
            "build/outputs/apk/release/app-release.apk"
          )
          
          APK_FILE=""
          for path in "${APK_PATHS[@]}"; do
            if [ -f "$path" ]; then
              APK_FILE="$path"
              break
            fi
          done
          
          if [ -z "$APK_FILE" ]; then
            echo "âŒ APK íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            find . -name "*.apk" -type f
            exit 1
          fi
          
          # APK íŒŒì¼ëª… ë³€ê²½
          NEW_APK_NAME="meettime-v${VERSION}.apk"
          cp "$APK_FILE" "../$NEW_APK_NAME"
          
          APK_SIZE=$(du -h "../$NEW_APK_NAME" | cut -f1)
          APK_PATH="../$NEW_APK_NAME"
          
          echo "apk-name=$NEW_APK_NAME" >> $GITHUB_OUTPUT
          echo "apk-path=$APK_PATH" >> $GITHUB_OUTPUT
          echo "apk-size=$APK_SIZE" >> $GITHUB_OUTPUT
          
          echo "ğŸ“± APK ì¤€ë¹„ ì™„ë£Œ: $NEW_APK_NAME ($APK_SIZE)"

      - name: ğŸ” APK Verification
        run: |
          APK_PATH="${{ steps.apk-info.outputs.apk-path }}"
          
          echo "ğŸ” APK ì„œëª… ê²€ì¦:"
          
          # APK ì„œëª… ì •ë³´ í™•ì¸
          if command -v jarsigner >/dev/null 2>&1; then
            jarsigner -verify -verbose -certs "$APK_PATH" | head -20
          fi
          
          # ê¸°ë³¸ íŒŒì¼ ì •ë³´
          ls -la "$APK_PATH"
          echo "âœ… APK ê²€ì¦ ì™„ë£Œ"

      - name: ğŸ“¤ Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: meettime-apk-${{ needs.check-version-update.outputs.version }}
          path: ${{ steps.apk-info.outputs.apk-path }}
          retention-days: 90

      - name: ğŸ‰ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.check-version-update.outputs.tag }}
          name: "ğŸš€ MeetTime ${{ needs.check-version-update.outputs.tag }}"
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            ${{ steps.apk-info.outputs.apk-path }}
          body: |
            ## ğŸš€ MeetTime ${{ needs.check-version-update.outputs.tag }}
            
            **í”„ë¡œë•ì…˜ í‚¤ìŠ¤í† ì–´ë¡œ ì„œëª…ëœ ì•ˆì •ì ì¸ ë²„ì „ì…ë‹ˆë‹¤!** ğŸ”
            
            ### ğŸ“± Android APK
            - **íŒŒì¼ëª…**: `${{ steps.apk-info.outputs.apk-name }}`
            - **í¬ê¸°**: ${{ steps.apk-info.outputs.apk-size }}
            - **ì„œëª…**: âœ… í”„ë¡œë•ì…˜ í‚¤ìŠ¤í† ì–´ë¡œ ì„œëª…ë¨
            - **ì—…ë°ì´íŠ¸ í˜¸í™˜**: âœ… ê¸°ì¡´ ì„¤ì¹˜ëœ ì•± ì—…ë°ì´íŠ¸ ê°€ëŠ¥
            
            ### ğŸŒ ì›¹ ë²„ì „
            [${{ env.WEBSITE_URL }}](${{ env.WEBSITE_URL }})
            
            ### ğŸ” ë³´ì•ˆ ì •ë³´
            - **í‚¤ìŠ¤í† ì–´**: í”„ë¡œë•ì…˜ìš© ì•ˆì „í•œ í‚¤ìŠ¤í† ì–´ ì‚¬ìš©
            - **ì„œëª… ê²€ì¦**: GitHub Actionsì—ì„œ ìë™ ê²€ì¦
            - **íŒ¨í‚¤ì§€ ID**: `${{ env.PACKAGE_ID }}`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“Š Build Summary
        run: |
          echo "ğŸ‰ MeetTime APK ë¹Œë“œ ì„±ê³µ!"
          echo "ğŸ“¦ ë²„ì „: ${{ needs.check-version-update.outputs.tag }}"
          echo "ğŸ“± APK: ${{ steps.apk-info.outputs.apk-name }}"
          echo "ğŸ”— ë¦´ë¦¬ì¦ˆ: https://github.com/${{ github.repository }}/releases/tag/${{ needs.check-version-update.outputs.tag }}"